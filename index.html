<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .nav-link.active {
            background-color: #4F46E5;
            color: white;
        }
        .sortable-ghost {
            background: #c8ebfb;
            opacity: 0.5;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        /* Custom suggestion box styles */
        .suggestion-item:hover {
            background-color: #f0f4ff;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto max-w-4xl p-4">
        <header class="bg-white rounded-lg shadow p-4 mb-6">
            <h1 class="text-3xl font-bold text-indigo-600">Calorie Tracker</h1>
            <nav class="mt-4 flex flex-wrap gap-2">
                <button class="nav-link px-4 py-2 rounded-md font-semibold text-gray-700 bg-gray-200 hover:bg-indigo-500 hover:text-white transition" data-view="daily-log">Daily Log</button>
                <button class="nav-link px-4 py-2 rounded-md font-semibold text-gray-700 bg-gray-200 hover:bg-indigo-500 hover:text-white transition" data-view="weekly-log">Weekly Log</button>
                <button class="nav-link px-4 py-2 rounded-md font-semibold text-gray-700 bg-gray-200 hover:bg-indigo-500 hover:text-white transition" data-view="weekly-totals">Week Total</button>
                <button class="nav-link px-4 py-2 rounded-md font-semibold text-gray-700 bg-gray-200 hover:bg-indigo-500 hover:text-white transition" data-view="weight">Weight</button>
            </nav>
        </header>

        <main>
            <!-- Daily Log View -->
            <div id="daily-log" class="view">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Daily Log</h2>
                        <input type="date" id="date-picker" class="p-2 border rounded-md">
                    </div>

                    <div class="mb-6">
                        <div class="flex justify-between items-center font-semibold">
                            <span>Total Calories: <span id="total-calories">0</span> / 1500</span>
                            <span id="calories-remaining">1500 remaining</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 mt-2">
                            <div id="calorie-progress" class="bg-indigo-600 h-4 rounded-full" style="width: 0%;"></div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">Add Food</h3>
                        <form id="add-food-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div class="md:col-span-2 relative">
                                <label for="food-name" class="block text-sm font-medium text-gray-700">Food Name</label>
                                <input id="food-name" name="food-name" type="text" required autocomplete="off" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <div id="food-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 shadow-lg hidden max-h-60 overflow-y-auto"></div>
                            </div>
                            <div>
                                <label for="calories" class="block text-sm font-medium text-gray-700">Calories</label>
                                <input id="calories" name="calories" type="number" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-semibold">Add Item</button>
                        </form>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold mb-2">Today's Log</h3>
                        <ul id="food-log-list" class="space-y-3">
                            <!-- Food items will be dynamically inserted here -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Weekly Log View -->
            <div id="weekly-log" class="view">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">Weekly Log</h2>
                    <div id="weekly-log-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Weekly log cards will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Weekly Totals View -->
            <div id="weekly-totals" class="view">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">Week Total</h2>
                    <div class="text-center mb-6">
                        <p class="text-lg text-gray-600">Total Calories for the Week</p>
                        <p class="text-5xl font-bold text-indigo-600"><span id="weekly-total-calories">0</span> kcal</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="weekly-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Weight Tracker View -->
            <div id="weight" class="view">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">Weight Tracker</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-semibold mb-2">Log Weight</h3>
                            <form id="weight-form" class="flex items-end gap-4">
                                <div>
                                    <label for="weight-input" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                                    <input type="number" step="0.1" id="weight-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                                </div>
                                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-semibold">Log</button>
                            </form>
                            <div class="mt-6">
                                <h3 class="text-xl font-semibold">Weight Stats</h3>
                                <div class="mt-2 space-y-2">
                                    <p><strong>Highest Weight:</strong> <span id="highest-weight">-</span> kg</p>
                                    <p><strong>Lowest Weight:</strong> <span id="lowest-weight">-</span> kg</p>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                             <canvas id="weight-chart"></canvas>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold mb-2">Weight History</h3>
                        <ul id="weight-log-list" class="space-y-2">
                            <!-- Weight log items will be inserted here -->
                        </ul>
                    </div>
                </div>
            </div>
             <!-- Data Management -->
            <div class="bg-white rounded-lg shadow p-6 mt-6">
                <h2 class="text-2xl font-bold mb-4">Data Management</h2>
                <div class="flex gap-4">
                    <button id="import-btn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 font-semibold">Import Data (JSON)</button>
                    <button id="export-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 font-semibold">Export Data (JSON)</button>
                    <input type="file" id="import-file" class="hidden" accept=".json">
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const MAX_CALORIES = 1500;

            // --- State Management ---
            let state = {
                dailyLogs: {}, // { 'YYYY-MM-DD': [{id, name, calories}, ...] }
                weightLogs: [], // { date: 'YYYY-MM-DD', weight: 80 }
                commonFoods: [
                    { name: "Coffee", calories: 40 },
                    { name: "Food (500 cal)", calories: 500 },
                    { name: "Food (400 cal)", calories: 400 },
                    { name: "Food (300 cal)", calories: 300 },
                    { name: "Food (200 cal)", calories: 200 },
                    { name: "Food (100 cal)", calories: 100 },
                    { name: "Food (50 cal)", calories: 50 },
                    { name: "Food (20 cal)", calories: 20 },
                    { name: "Food (10 cal)", calories: 10 },
                    { name: "Fruits - Banana", calories: 100 },
                    { name: "Fruits - Peach", calories: 70 },
                    { name: "Fruits - Avocado", calories: 250 },
                    { name: "Fruits - Apple", calories: 95 },
                    { name: "Dairy/Eggs - Eggs", calories: 70 },
                    { name: "Dairy/Eggs - Yogurt", calories: 80 },
                    { name: "Dairy/Eggs - Milk", calories: 150 },
                    { name: "Dairy/Eggs - Almond Milk (80 cal)", calories: 80 },
                    { name: "Dairy/Eggs - Almond Milk (30 cal)", calories: 30 },
                    { name: "Dairy/Eggs - Cheese (80 cal)", calories: 80 },
                    { name: "Dairy/Eggs - Cheese (50 cal)", calories: 50 },
                    { name: "Grains - Whole Wheat Bread", calories: 110 },
                    { name: "Grains - Bread (70 cal)", calories: 70 },
                    { name: "Grains - Bread (35 cal)", calories: 35 },
                    { name: "Grains - Oatmeal", calories: 300 },
                    { name: "Other Foods - Bacon", calories: 440 },
                    { name: "Other Foods - Sausage", calories: 360 },
                    { name: "Other Foods - Beans", calories: 440 },
                    { name: "Other Foods - Ham", calories: 80 },
                    { name: "Other Foods - Peanut Butter", calories: 100 },
                    { name: "Other Foods - Popsicle", calories: 40 },
                    { name: "Other Foods - Sauce", calories: 50 },
                    { name: "Other Foods - Oreo", calories: 340 },
                    { name: "Other Foods - Andes Mint", calories: 25 },
                    { name: "Other Foods - Hershey Kiss", calories: 15 },
                    { name: "Chick-fil-A - Deluxe Sandwich", calories: 490 },
                    { name: "Chick-fil-A - Sandwich", calories: 440 },
                    { name: "Chick-fil-A - Strips", calories: 410 },
                    { name: "Chick-fil-A - Biscuit", calories: 460 },
                    { name: "Chick-fil-A - Fries", calories: 440 },
                    { name: "Chick-fil-A - Zesty Sauce", calories: 25 },
                    { name: "Chick-fil-A - Shake", calories: 560 },
                    { name: "Chick-fil-A - Lemonade", calories: 320 },
                    { name: "McDonald's - Big Mac", calories: 550 },
                    { name: "McDonald's - Fries", calories: 440 },
                    { name: "McDonald's - Quarter Pounder", calories: 520 },
                    { name: "McDonald's - Egg McMuffin", calories: 480 },
                    { name: "McDonald's - McNuggets", calories: 410 },
                    { name: "Burger King - Whopper", calories: 670 },
                    { name: "Burger King - Fries", calories: 440 },
                    { name: "Freddies - Lettuce Wrap Burger", calories: 500 },
                    { name: "Freddies - Fries", calories: 440 },
                    { name: "Dunkin - Donut", calories: 240 },
                    { name: "Dunkin - Biscuit (470 cal)", calories: 470 },
                    { name: "Dunkin - Biscuit (400 cal)", calories: 400 },
                    { name: "Dunkin - Wrap", calories: 210 },
                    { name: "Salsarita's - Quesadilla", calories: 590 },
                    { name: "Salsarita's - Bowl", calories: 800 },
                    { name: "Taco Bell - Quesadilla", calories: 510 },
                    { name: "Taco Bell - Chalupa", calories: 360 }
                ]
            };

            // --- DOM Elements ---
            const views = document.querySelectorAll('.view');
            const navLinks = document.querySelectorAll('.nav-link');
            const datePicker = document.getElementById('date-picker');
            const foodLogList = document.getElementById('food-log-list');
            const addFoodForm = document.getElementById('add-food-form');
            const foodNameInput = document.getElementById('food-name');
            const caloriesInput = document.getElementById('calories');
            const foodSuggestions = document.getElementById('food-suggestions');
            const totalCaloriesEl = document.getElementById('total-calories');
            const caloriesRemainingEl = document.getElementById('calories-remaining');
            const calorieProgress = document.getElementById('calorie-progress');
            
            const weeklyLogContainer = document.getElementById('weekly-log-container');
            const weeklyChartCanvas = document.getElementById('weekly-chart');
            const weeklyTotalCaloriesEl = document.getElementById('weekly-total-calories');
            let weeklyChart;

            const weightForm = document.getElementById('weight-form');
            const weightInput = document.getElementById('weight-input');
            const weightLogList = document.getElementById('weight-log-list');
            const highestWeightEl = document.getElementById('highest-weight');
            const lowestWeightEl = document.getElementById('lowest-weight');
            const weightChartCanvas = document.getElementById('weight-chart');
            let weightChart;
            
            const importBtn = document.getElementById('import-btn');
            const exportBtn = document.getElementById('export-btn');
            const importFile = document.getElementById('import-file');


            // --- Utility Functions ---
            const getTodayString = () => new Date().toISOString().split('T')[0];
            
            const saveState = () => {
                localStorage.setItem('calorieTrackerState', JSON.stringify(state));
            };

            const loadState = () => {
                const savedState = localStorage.getItem('calorieTrackerState');
                if (savedState) {
                    state = JSON.parse(savedState);
                }
            };

            // --- Navigation ---
            const switchView = (viewId) => {
                views.forEach(view => view.classList.remove('active'));
                navLinks.forEach(link => link.classList.remove('active'));
                
                document.getElementById(viewId).classList.add('active');
                document.querySelector(`.nav-link[data-view="${viewId}"]`).classList.add('active');

                // Refresh view content
                switch (viewId) {
                    case 'daily-log':
                        renderDailyLog();
                        break;
                    case 'weekly-log':
                        renderWeeklyLog();
                        break;
                    case 'weekly-totals':
                        renderWeeklyTotals();
                        break;
                    case 'weight':
                        renderWeightTracker();
                        break;
                }
            };

            navLinks.forEach(link => {
                link.addEventListener('click', () => switchView(link.dataset.view));
            });

            // --- Daily Log Logic ---
            const renderDailyLog = () => {
                const selectedDate = datePicker.value;
                const log = state.dailyLogs[selectedDate] || [];
                foodLogList.innerHTML = '';
                let totalCalories = 0;

                log.forEach(item => {
                    totalCalories += item.calories;
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-md shadow-sm';
                    li.dataset.id = item.id;
                    li.innerHTML = `
                        <div class="flex-grow">
                            <input type="text" value="${item.name}" class="font-semibold bg-transparent w-full" data-id="${item.id}" data-field="name" readonly>
                            <input type="number" value="${item.calories}" class="text-gray-600 bg-transparent w-full" data-id="${item.id}" data-field="calories" readonly>
                        </div>
                        <div class="flex items-center gap-2">
                             <button class="edit-btn text-blue-500 hover:text-blue-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                             <button class="delete-btn text-red-500 hover:text-red-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    `;
                    foodLogList.appendChild(li);
                });

                totalCaloriesEl.textContent = totalCalories;
                const remaining = MAX_CALORIES - totalCalories;
                caloriesRemainingEl.textContent = `${remaining >= 0 ? remaining : 0} remaining`;
                if(remaining < 0) {
                    caloriesRemainingEl.textContent = `${Math.abs(remaining)} over`;
                    caloriesRemainingEl.classList.add('text-red-500');
                } else {
                     caloriesRemainingEl.classList.remove('text-red-500');
                }
                
                const progressPercentage = Math.min((totalCalories / MAX_CALORIES) * 100, 100);
                calorieProgress.style.width = `${progressPercentage}%`;
                calorieProgress.classList.toggle('bg-red-500', totalCalories > MAX_CALORIES);
                calorieProgress.classList.toggle('bg-indigo-600', totalCalories <= MAX_CALORIES);
            };

            const addFoodItem = (name, calories) => {
                const selectedDate = datePicker.value;
                if (!state.dailyLogs[selectedDate]) {
                    state.dailyLogs[selectedDate] = [];
                }
                const newItem = {
                    id: Date.now(),
                    name,
                    calories: parseInt(calories, 10)
                };
                state.dailyLogs[selectedDate].push(newItem);
                saveState();
                renderDailyLog();
            };
            
            const updateFoodItem = (id, field, value) => {
                const selectedDate = datePicker.value;
                const log = state.dailyLogs[selectedDate];
                if (log) {
                    const item = log.find(i => i.id == id);
                    if (item) {
                        item[field] = field === 'calories' ? parseInt(value, 10) : value;
                        saveState();
                        renderDailyLog();
                    }
                }
            };
            
            const deleteFoodItem = (id) => {
                const selectedDate = datePicker.value;
                const log = state.dailyLogs[selectedDate];
                if (log) {
                    state.dailyLogs[selectedDate] = log.filter(i => i.id != id);
                    saveState();
                    renderDailyLog();
                }
            };

            addFoodForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = foodNameInput.value.trim();
                const calories = caloriesInput.value;
                if (name && calories) {
                    addFoodItem(name, calories);
                    addFoodForm.reset();
                    foodNameInput.focus();
                }
            });
            
            foodLogList.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const li = button.closest('li');
                const id = li.dataset.id;

                if (button.classList.contains('delete-btn')) {
                    deleteFoodItem(id);
                } else if (button.classList.contains('edit-btn')) {
                    const nameInput = li.querySelector('input[data-field="name"]');
                    const caloriesInput = li.querySelector('input[data-field="calories"]');
                    const isReadonly = nameInput.hasAttribute('readonly');

                    if (isReadonly) {
                        nameInput.removeAttribute('readonly');
                        caloriesInput.removeAttribute('readonly');
                        nameInput.focus();
                        button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
                        button.classList.remove('text-blue-500', 'hover:text-blue-700');
                        button.classList.add('text-green-500', 'hover:text-green-700');
                    } else {
                        nameInput.setAttribute('readonly', true);
                        caloriesInput.setAttribute('readonly', true);
                        updateFoodItem(id, 'name', nameInput.value);
                        updateFoodItem(id, 'calories', caloriesInput.value);
                        button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>`;
                        button.classList.add('text-blue-500', 'hover:text-blue-700');
                        button.classList.remove('text-green-500', 'hover:text-green-700');
                    }
                }
            });

            Sortable.create(foodLogList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: (evt) => {
                    const selectedDate = datePicker.value;
                    const log = state.dailyLogs[selectedDate];
                    if (log) {
                        const [movedItem] = log.splice(evt.oldIndex, 1);
                        log.splice(evt.newIndex, 0, movedItem);
                        saveState();
                    }
                }
            });

            datePicker.addEventListener('change', renderDailyLog);
            
            const showSuggestions = (query = '') => {
                const lowerCaseQuery = query.toLowerCase();
                const filteredFoods = state.commonFoods.filter(food => food.name.toLowerCase().includes(lowerCaseQuery));
                
                if (filteredFoods.length > 0) {
                    foodSuggestions.innerHTML = filteredFoods.slice(0, 50).map(food => 
                        `<div class="suggestion-item p-2 cursor-pointer" data-name="${food.name}" data-calories="${food.calories}">
                            ${food.name} <span class="text-sm text-gray-500">- ${food.calories} kcal</span>
                        </div>`
                    ).join('');
                    foodSuggestions.classList.remove('hidden');
                } else {
                    foodSuggestions.classList.add('hidden');
                }
            };

            foodNameInput.addEventListener('input', () => showSuggestions(foodNameInput.value));
            foodNameInput.addEventListener('focus', () => showSuggestions(foodNameInput.value));

            foodSuggestions.addEventListener('click', (e) => {
                const item = e.target.closest('.suggestion-item');
                if (item) {
                    foodNameInput.value = item.dataset.name;
                    caloriesInput.value = item.dataset.calories;
                    foodSuggestions.classList.add('hidden');
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!addFoodForm.contains(e.target)) {
                    foodSuggestions.classList.add('hidden');
                }
            });


            // --- Weekly Log & Totals ---
            const getWeekData = () => {
                const today = new Date();
                const dayOfWeek = today.getDay(); // Sunday - 0, Monday - 1
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); // Adjust to Monday start

                const weekData = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    const dateString = date.toISOString().split('T')[0];
                    const log = state.dailyLogs[dateString] || [];
                    const totalCalories = log.reduce((sum, item) => sum + item.calories, 0);
                    weekData.push({ date: dateString, totalCalories });
                }
                return weekData;
            };
            
            const renderWeeklyLog = () => {
                const weekData = getWeekData();
                weeklyLogContainer.innerHTML = '';
                weekData.forEach(day => {
                    const date = new Date(day.date);
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                    const card = document.createElement('div');
                    card.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
                    card.innerHTML = `
                        <p class="font-bold text-lg">${dayName}</p>
                        <p class="text-sm text-gray-500">${day.date}</p>
                        <p class="mt-2 text-2xl font-semibold text-indigo-600">${day.totalCalories} <span class="text-base font-normal text-gray-600">kcal</span></p>
                         <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                            <div class="h-2.5 rounded-full ${day.totalCalories > MAX_CALORIES ? 'bg-red-500' : 'bg-indigo-600'}" style="width: ${Math.min((day.totalCalories / MAX_CALORIES) * 100, 100)}%"></div>
                        </div>
                    `;
                    weeklyLogContainer.appendChild(card);
                });
            };

            const renderWeeklyTotals = () => {
                const weekData = getWeekData();
                const labels = weekData.map(d => new Date(d.date).toLocaleDateString('en-US', { weekday: 'short' }));
                const data = weekData.map(d => d.totalCalories);
                const totalWeeklyCalories = data.reduce((sum, cals) => sum + cals, 0);

                weeklyTotalCaloriesEl.textContent = totalWeeklyCalories;

                if (weeklyChart) {
                    weeklyChart.destroy();
                }

                weeklyChart = new Chart(weeklyChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Daily Calories',
                            data: data,
                            backgroundColor: data.map(cal => cal > MAX_CALORIES ? 'rgba(239, 68, 68, 0.6)' : 'rgba(79, 70, 229, 0.6)'),
                            borderColor: data.map(cal => cal > MAX_CALORIES ? 'rgba(239, 68, 68, 1)' : 'rgba(79, 70, 229, 1)'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Daily Calories This Week'
                            }
                        }
                    }
                });
            };

            // --- Weight Tracker Logic ---
            const renderWeightTracker = () => {
                weightLogList.innerHTML = '';
                state.weightLogs.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort descending

                state.weightLogs.forEach(log => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-md';
                    li.innerHTML = `
                        <span>${new Date(log.date).toLocaleDateString()}</span>
                        <span class="font-semibold">${log.weight} kg</span>
                    `;
                    weightLogList.appendChild(li);
                });
                
                updateWeightStats();
                renderWeightChart();
            };
            
            const updateWeightStats = () => {
                if (state.weightLogs.length === 0) {
                    highestWeightEl.textContent = '-';
                    lowestWeightEl.textContent = '-';
                    return;
                }
                const weights = state.weightLogs.map(log => log.weight);
                highestWeightEl.textContent = Math.max(...weights);
                lowestWeightEl.textContent = Math.min(...weights);
            };

            const renderWeightChart = () => {
                const sortedLogs = [...state.weightLogs].sort((a, b) => new Date(a.date) - new Date(b.date));
                const labels = sortedLogs.map(log => new Date(log.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                const data = sortedLogs.map(log => log.weight);

                if (weightChart) {
                    weightChart.destroy();
                }

                weightChart = new Chart(weightChartCanvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Weight (kg)',
                            data: data,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                         plugins: {
                            title: {
                                display: true,
                                text: 'Weight Trend'
                            }
                        }
                    }
                });
            };

            weightForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const weight = parseFloat(weightInput.value);
                if (weight > 0) {
                    const today = getTodayString();
                    // Check if there's already a log for today and update it, otherwise add new
                    const existingLogIndex = state.weightLogs.findIndex(log => log.date === today);
                    if (existingLogIndex > -1) {
                        state.weightLogs[existingLogIndex].weight = weight;
                    } else {
                        state.weightLogs.push({ date: today, weight: weight });
                    }
                    saveState();
                    renderWeightTracker();
                    weightForm.reset();
                }
            });
            
            // --- Data Import/Export ---
            exportBtn.addEventListener('click', () => {
                const dataStr = JSON.stringify(state, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'calorie-tracker-data.json';
                a.click();
                URL.revokeObjectURL(url);
            });

            importBtn.addEventListener('click', () => {
                importFile.click();
            });

            importFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        // Basic validation
                        if (importedState.dailyLogs && importedState.weightLogs) {
                            state = importedState;
                            saveState();
                            // Re-initialize the app with new state
                            init();
                            alert('Data imported successfully!');
                        } else {
                            alert('Invalid data file format.');
                        }
                    } catch (error) {
                        console.error('Error importing data:', error);
                        alert('Could not parse the file. Make sure it is a valid JSON file.');
                    }
                };
                reader.readAsText(file);
                // Reset file input
                importFile.value = '';
            });

            // --- Initialization ---
            const init = () => {
                loadState();
                datePicker.value = getTodayString();
                switchView('daily-log');
            };

            init();
        });
    </script>
</body>
</html>

